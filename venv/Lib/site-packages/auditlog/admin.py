from django.contrib import admin, messages
from .models import LogEntry
from .mixins import LogEntryAdminMixin
from .filters import ResourceTypeFilter


class LogEntryAdmin(admin.ModelAdmin, LogEntryAdminMixin):
    list_display = ['created', 'resource_url', 'action', 'msg_short', 'user_url']
    search_fields = ['timestamp', 'object_repr', 'changes', 'actor__username']
    list_filter = ['action', ResourceTypeFilter]
    readonly_fields = ['created', 'resource_url', 'action', 'user_url', 'msg']
    fieldsets = [
        (None, {'fields': ['created', 'user_url', 'resource_url']}),
        ('Modificações', {'fields': ['action', 'msg']}),
    ]

    def save_model(self, request, obj, form, change):
        try:
            if obj.action == None:
                messages.info["Nao pode salvar"]
                # requisitante = Requisitante.objects.get(id_user=request.user.pk)
                # obj.solicitante = requisitante
                # obj.chave_anonimo = requisitante.chave_identificacao
                # obj.longitude = request.POST.get('codigo_longitude') or None
                # obj.lagitude = request.POST.get('codigo_latitude') or None
                obj.action = 1
                obj.save()
        except:
            pass

admin.site.register(LogEntry, LogEntryAdmin)
